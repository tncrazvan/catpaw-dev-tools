#!/usr/bin/env php
<?php
use CatPaw\Environment\Attributes\Environment;
use CatPaw\Environment\Attributes\EnvironmentFileName;

use function Amp\call;
use function CatPaw\execute;



/**
 * 
 * @param array{
 *  dev-tools: array{
 *   version: string,
 *   message: string
 *  },
 *  core: array{
 *   version: string,
 *   message: string
 *  },
 *  cli: array{
 *   version: string,
 *   message: string
 *  },
 *  environment: array{
 *   version: string,
 *   message: string
 *  },
 *  examples: array{
 *   version: string,
 *   message: string
 *  },
 *  mysql: array{
 *   version: string,
 *   message: string
 *  },
 *  mysql-dbms: array{
 *   version: string,
 *   message: string
 *  },
 *  optional: array{
 *   version: string,
 *   message: string
 *  },
 *  queue: array{
 *   version: string,
 *   message: string
 *  },
 *  raspberrypi: array{
 *   version: string,
 *   message: string
 *  },
 *  starter: array{
 *   version: string,
 *   message: string
 *  },
 *  store: array{
 *   version: string,
 *   message: string
 *  },
 *  web: array{
 *   version: string,
 *   message: string
 *  },
 *  cui: array{
 *   version: string,
 *   message: string
 *  },
 *  spa: array{
 *   version: string,
 *   message: string
 *  },
 *  web-starter: array{
 *   version: string,
 *   message: string
 *  },
 *  svelte-starter: array{
 *   version: string,
 *   message: string
 *  }
 * } $projects 
 * @return void 
 * @throws Error 
 */
#[EnvironmentFileName('.env.yml')]
function main(
    #[Environment('projects')] array $projects,
){
    chdir(dirname(__FILE__));
    $root = realpath('../../');

    foreach($projects as $project => $options){
        $version = preg_replace('/"/','\\"',$options['version']);
        $message = preg_replace('/"/','\\"',$options['message']);
        echo "Tagging project catpaw-$project".PHP_EOL;
        $cwd = "$root/catpaw-$project";
        call(function() use($version,$message,$cwd){
            yield execute("git add .",$cwd);
            yield execute("git commit -m\"$message\"",$cwd);
            yield execute("git push",$cwd);
            yield execute("git tag -a \"$version\" -m\"$message\"",$cwd);
            yield execute("git push --tags",$cwd);
        });
    }
}
