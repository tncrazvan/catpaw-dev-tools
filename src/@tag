#!/usr/bin/env php
<?php
/**
 * @psalm-type ProjectName = "dev-tools" | "core" | "cli" | "environment" | "examples" | "mysql" | "mysql-dbms" | "optional" | "queue" | "raspberrypi" | "starter" | "store" | "web" | "cui" | "spa" | "web-starter" | "svelte-starter"
 */

use CatPaw\Environment\Attributes\Environment;
use CatPaw\Environment\Attributes\EnvironmentFileName;

use function Amp\call;
use function CatPaw\execute;


/**
 * @param array<ProjectName,array{version:string,message:string}> $projects 
 * @param string $version 
 * @param string $message 
 * @return void 
 * @throws Error 
 */
#[EnvironmentFileName('.env.yml')]
function main(
    #[Environment('projects')] array $projects,
    #[Environment('version')] string $version,
    #[Environment('message')] string $message,
){
    chdir(dirname(__FILE__));
    $root = realpath('../../');

    foreach($projects as $project => $options){
        $version = preg_replace('/"/','\\"',$options['version']);
        $message = preg_replace('/"/','\\"',$options['message']);
        echo "Tagging project catpaw-$project".PHP_EOL;
        $cwd = "$root/catpaw-$project";
        call(function() use($version,$message,$cwd){
            yield execute("git add .",$cwd);
            yield execute("git commit -m\"$message\"",$cwd);
            yield execute("git push",$cwd);
            yield execute("git tag -a \"$version\" -m\"$message\"",$cwd);
            yield execute("git push --tags",$cwd);
        });
    }
}
